/*!
 * @zevanoo/baileys-ez v1.0.0
 * Copyright (c) 2025 Zevano
 * Licensed under MIT
 */

import{makeWASocket as g,useMultiFileAuthState as k,DisconnectReason as C,Browsers as b}from"baileys";import{Boom as y}from"@hapi/boom";import{EventEmitter as w}from"events";import{serialize as z}from"../client/serialize.js";import{Action as I}from"../client/action.js";import{Func as P}from"../utils/func.js";import{fileURLToPath as W}from"url";import{glob as A}from"glob";import"fs";import l from"path";class U extends w{constructor({id:t,number:e,pairingCode:s,baileysConfig:n={},serializer:a}){super(),this.id=t,this.number=e,this.pairingCode=s,this.baileysConfig=n,this.serializer=a,this.sock=null,this.sessionPath=null,global.WrapperInstance&&(global.WrapperInstance.addClient(this),this.pairingCode=global.WrapperInstance.pairingCode)}async connect(){try{const t=global.sessionFolder||"sessions";this.sessionPath=l.join(process.cwd(),t,this.id);const{state:e,saveCreds:s}=await k(this.sessionPath),a={...{browser:b.ubuntu("Chrome"),printQRInTerminal:!1,auth:e},...global.WrapperInstance.baileysConfig,...this.baileysConfig};if(this.sock=g(a),this.sock&&!this.sock.authState.creds.registered){await P.sleep(2e3);const r=await this.sock.requestPairingCode(this.number,this.pairingCode);this.emit("connection",{status:"pairing-code",code:r})}this._bindActionMethods(),this.sock&&this.loadListeners(this.sock,this),this.sock.ev.on("connection.update",r=>{var h,f,u,d;const{connection:o,lastDisconnect:c}=r;if(o==="connecting"&&this.emit("connection",{status:"connecting"}),o==="open"&&this.emit("connection",{status:"open"}),o==="close"){const p=c==null?void 0:c.error,i=p instanceof y?p:void 0,m=((h=i==null?void 0:i.output)==null?void 0:h.statusCode)!==C.loggedOut;this.emit("connection",{status:"close",statusCode:(f=i==null?void 0:i.output)==null?void 0:f.statusCode,reason:((d=(u=i==null?void 0:i.output)==null?void 0:u.payload)==null?void 0:d.message)||"Unknown",shouldReconnect:m}),m&&setTimeout(()=>{this.connect()},5e3)}}),this.sock.ev.on("creds.update",s)}catch(t){this.emit("error",t)}}_bindActionMethods(){if(!this.sock)return;const t=new I(this.sock),e=Object.getOwnPropertyNames(Object.getPrototypeOf(t)).filter(s=>s!=="constructor"&&typeof t[s]=="function");for(const s of e)this.sock[s]=(...n)=>t[s].apply(t,n)}async disconnect(){this.sock&&(this.sock.ws&&this.sock.ws.close(),this.sock=null)}async loadListeners(t,e){const s=l.dirname(W(import.meta.url)),n=l.join(s,"..","listeners"),a=await A(`${n}/**/*.js`);for(const r of a)try{const o=await import(r);typeof o.default=="function"&&o.default(t,e)}catch(o){console.error(`Failed to load listener from ${r}:`,o)}}serializeMessage(t,e){var s;return this.serializer?this.serializer(t,e):(s=global.WrapperInstance)!=null&&s.serialize?global.WrapperInstance.serialize(t,e):z(t,e)}}export{U as Client};
