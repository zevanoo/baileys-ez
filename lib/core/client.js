/*!
 * @zevanoo/baileys-ez v1.0.0
 * Copyright (c) 2025 Zevano
 * Licensed under MIT
 */

import{makeWASocket as C,useMultiFileAuthState as k,DisconnectReason as b,Browsers as w}from"baileys";import{Boom as y}from"@hapi/boom";import{EventEmitter as z}from"events";import{serialize as I}from"../client/serialize.js";import{Action as P}from"../client/action.js";import{Func as W}from"../utils/func.js";import{fileURLToPath as A}from"url";import{glob as F}from"glob";import h from"path";class B extends z{constructor({id:t,number:s,pairingCode:e,baileysConfig:n={},serializer:r}){super(),this.id=t,this.number=s,this.pairingCode=e,this.baileysConfig=n,this.serializer=r,this.sock=null,this.sessionPath=null,global.WrapperInstance&&(global.WrapperInstance.addClient(this),this.pairingCode=global.WrapperInstance.pairingCode)}async connect(){var t;try{const s=global.sessionFolder||"sessions";this.sessionPath=h.join(process.cwd(),s,this.id);const{state:e,saveCreds:n}=await k(this.sessionPath),a={...{browser:w.ubuntu("Chrome"),printQRInTerminal:!1,auth:e},...(t=global.WrapperInstance)==null?void 0:t.baileysConfig,...this.baileysConfig};if(this.sock=C(a),!this.sock.authState.creds.registered){await W.sleep(2e3);const o=await this.sock.requestPairingCode(this.number,this.pairingCode);this.emit("connection",{status:"pairing-code",code:o})}this._bindActionMethods(),await this.loadListeners(this.sock,this),this.sock.ev.on("connection.update",o=>{var u,d,f,p;const{connection:c,lastDisconnect:l}=o;if(c==="connecting"&&this.emit("connection",{status:"connecting"}),c==="open"&&this.emit("connection",{status:"open"}),c==="close"){const m=l==null?void 0:l.error,i=m instanceof y?m:void 0,g=((u=i==null?void 0:i.output)==null?void 0:u.statusCode)!==b.loggedOut;this.emit("connection",{status:"close",statusCode:(d=i==null?void 0:i.output)==null?void 0:d.statusCode,reason:((p=(f=i==null?void 0:i.output)==null?void 0:f.payload)==null?void 0:p.message)||"Unknown",shouldReconnect:g}),g&&setTimeout(()=>this.connect(),5e3)}}),this.sock.ev.on("creds.update",n)}catch(s){this.emit("error",s)}}_bindActionMethods(){if(!this.sock)return;const t=new P(this.sock),s=Object.getOwnPropertyNames(Object.getPrototypeOf(t)).filter(e=>e!=="constructor"&&typeof t[e]=="function");for(const e of s)this.sock[e]=(...n)=>t[e].apply(t,n)}async disconnect(){this.sock&&(this.sock.ws&&this.sock.ws.close(),this.sock=null)}async loadListeners(t,s){const e=h.dirname(A(import.meta.url)),n=h.join(e,"..","listeners"),r=await F(`${n}/**/*.js`);for(const a of r)try{const o=await import(a);typeof o.default=="function"&&o.default(t,s)}catch(o){console.error(`Failed to load listener from ${a}:`,o)}}serializeMessage(t,s){var e;return this.serializer?this.serializer(t,s):(e=global.WrapperInstance)!=null&&e.serializer?global.WrapperInstance.serializer(t,s):I(t,s)}}export{B as Client};
