/*!
 * @zevanoo/baileys-ez v1.0.0
 * Copyright (c) 2025 Zevano
 * Licensed under MIT
 */

import{jidNormalizedUser as p,toBuffer as w,generateWAMessageFromContent as _,downloadContentFromMessage as h,normalizeMessageContent as b,isJidGroup as x,generateMessageID as f}from"baileys";import{Func as B}from"../utils/func.js";function N(a=[]){return a.map((e,t)=>{var s;return e&&e.name&&e.buttonParamsJson?e:e&&(e.id||e.text)?{name:"quick_reply",buttonParamsJson:JSON.stringify({display_text:e.text||e.displayText||"Button "+(t+1),id:e.id||"quick_"+(t+1)})}:e&&e.buttonId&&((s=e.buttonText)!=null&&s.displayText)?{name:"quick_reply",buttonParamsJson:JSON.stringify({display_text:e.buttonText.displayText,id:e.buttonId})}:e})}function k(a){var e;return a.listMessage?"list":a.buttonsMessage?"buttons":(e=a.interactiveMessage)!=null&&e.nativeFlowMessage?"native_flow":null}function I(a){var i,o,n;const e=(i=a.interactiveMessage)==null?void 0:i.nativeFlowMessage,t=(n=(o=e==null?void 0:e.buttons)==null?void 0:o[0])==null?void 0:n.name,s=["mpm","cta_catalog","send_location","call_permission_request","wa_payment_transaction_details","automated_greeting_message_view_catalog"];return e&&(t==="review_and_pay"||t==="payment_info")?{tag:"biz",attrs:{native_flow_name:t==="review_and_pay"?"order_details":t}}:e&&s.includes(t)?{tag:"biz",attrs:{},content:[{tag:"interactive",attrs:{type:"native_flow",v:"1"},content:[{tag:"native_flow",attrs:{v:"2",name:t}}]}]}:e||a.buttonsMessage?{tag:"biz",attrs:{},content:[{tag:"interactive",attrs:{type:"native_flow",v:"1"},content:[{tag:"native_flow",attrs:{v:"9",name:"mixed"}}]}]}:a.listMessage?{tag:"biz",attrs:{},content:[{tag:"list",attrs:{v:"2",type:"product_list"}}]}:{tag:"biz",attrs:{}}}function C(a){if(a.interactiveButtons&&a.interactiveButtons.length>0){const e={nativeFlowMessage:{buttons:a.interactiveButtons.map(s=>({name:s.name||"quick_reply",buttonParamsJson:s.buttonParamsJson}))}};(a.title||a.subtitle)&&(e.header={title:a.title||a.subtitle||""}),a.text&&(e.body={text:a.text}),a.footer&&(e.footer={text:a.footer});const t={...a};return delete t.interactiveButtons,delete t.title,delete t.subtitle,delete t.text,delete t.footer,{...t,interactiveMessage:e}}return a}async function y(a,e,t,s={}){var u,d,m,g;if(!a)throw new Error("Socket is required for sendInteractiveMessage");const i=C(t),o=((m=(d=(u=a.authState)==null?void 0:u.creds)==null?void 0:d.me)==null?void 0:m.id)||((g=a.user)==null?void 0:g.id),n=_(e,i,{logger:a.logger,userJid:o,messageId:f?f():void 0,timestamp:new Date,...s}),r=b(n.message);if(!r)return n;const c=k(r);let l=[...s.additionalNodes||[]];if(c){const v=I(r),M=!x(e);l.push(v),M&&l.push({tag:"bot",attrs:{biz_bot:"1"}})}return await a.relayMessage(e,n.message,{messageId:n.key.id,useCachedGroupMetadata:s.useCachedGroupMetadata,additionalAttributes:s.additionalAttributes||{},statusJidList:s.statusJidList,additionalNodes:l}),n}async function J(a,e,t={},s={}){const{text:i="",footer:o="",title:n,subtitle:r,buttons:c=[]}=t,l=N(c),u={text:i,footer:o,interactiveButtons:l};return n&&(u.title=n),r&&(u.subtitle=r),y(a,e,u,s)}class z{constructor(e){this.sock=e}decodeJid(e){return/:\d+@/gi.test(e)?p(e):e}async sendText(e,t,s={}){return await this.sock.sendMessage(e,{text:t},s)}async react(e,t,s){return await this.sock.sendMessage(e,{react:{text:s,key:t}})}async sendContact(e,t,s={}){const i=Array.isArray(t)?t:[t],o=i.map(n=>`BEGIN:VCARD
VERSION:3.0
FN:${n.name}
TEL;type=CELL;type=VOICE;waid=${n.number}:${n.number}
${n.about?`NOTE:${n.about}
`:""}END:VCARD`);return await this.sock.sendMessage(e,{contacts:{displayName:i.length===1?i[0].name:`${i.length} contacts`,contacts:i.map(n=>({vcard:o.shift()}))}},s)}async sendButtons(e,t,s){return await J(this.sock,e,t,s)}async sendInteractiveMessage(e,t,s){return await y(this.sock,e,t,s)}async downloadMediaMessage(e){var o,n,r,c,l,u,d,m;let t=(o=e.msg)!=null&&o.audioMessage?"audio":(n=e.msg)!=null&&n.videoMessage?"video":(r=e.msg)!=null&&r.imageMessage?"image":(c=e.msg)!=null&&c.stickerMessage?"sticker":(l=e.msg)!=null&&l.documentMessage?"document":(u=e.msg)!=null&&u.ptvMessage?"video":void 0,s=e.msg;(d=e.msg)!=null&&d.thumbnailDirectPath&&!((m=e.msg)!=null&&m.url)&&(s={directPath:e.msg.thumbnailDirectPath,mediaKey:e.msg.mediaKey},t="thumbnail-link");const i=await h(s,t);return await w(i)}parseMention(e){return[...e.matchAll(/@([0-9]{5,16}|0)/g)].map(t=>t[1]+"@s.whatsapp.net")||[]}async sendMedia(e,t,s="",i={}){var o;try{const{mime:n,data:r,ext:c,size:l}=await B.getFile(t),u=i!=null&&i.mimetype?i.mimetype:n;let d;return l>45e6||i.asDocument?d={document:r,mimetype:u,fileName:(i==null?void 0:i.fileName)||`${(o=this.sock.user)==null?void 0:o.name} (${new Date}).${c}`,...i}:/image/.test(u)?d={image:r,mimetype:"image/png",...i}:/video/.test(u)?d={video:r,mimetype:"video/mp4",...i}:/audio/.test(u)?d={audio:r,mimetype:"audio/mp4",...i}:d={document:r,mimetype:u,...i},await this.sock.sendMessage(e,d,{quoted:typeof s=="string"?void 0:s,...i})}catch(n){console.error(n);return}}}export{z as Action};
