/*!
 * @zevanoo/baileys-ez v1.0.0
 * Copyright (c) 2025 Zevano
 * Licensed under MIT
 */

import{jidNormalizedUser as w,toBuffer as h,generateWAMessageFromContent as _,downloadContentFromMessage as b,normalizeMessageContent as p,isJidGroup as N,generateMessageID as f}from"baileys";import{Func as x}from"../utils/func.js";function k(s=[]){return s.map((e,t)=>{var i;return e&&e.name&&e.buttonParamsJson?e:e&&(e.id||e.text)?{name:"quick_reply",buttonParamsJson:JSON.stringify({display_text:e.text||e.displayText||"Button "+(t+1),id:e.id||"quick_"+(t+1)})}:e&&e.buttonId&&((i=e.buttonText)!=null&&i.displayText)?{name:"quick_reply",buttonParamsJson:JSON.stringify({display_text:e.buttonText.displayText,id:e.buttonId})}:e})}function C(s){var e;return s.listMessage?"list":s.buttonsMessage?"buttons":(e=s.interactiveMessage)!=null&&e.nativeFlowMessage?"native_flow":null}function I(s){var a,m,r;const e=(a=s.interactiveMessage)==null?void 0:a.nativeFlowMessage,t=(r=(m=e==null?void 0:e.buttons)==null?void 0:m[0])==null?void 0:r.name,i=["mpm","cta_catalog","send_location","call_permission_request","wa_payment_transaction_details","automated_greeting_message_view_catalog"];return e&&(t==="review_and_pay"||t==="payment_info")?{tag:"biz",attrs:{native_flow_name:t==="review_and_pay"?"order_details":t}}:e&&i.includes(t)?{tag:"biz",attrs:{},content:[{tag:"interactive",attrs:{type:"native_flow",v:"1"},content:[{tag:"native_flow",attrs:{v:"2",name:t}}]}]}:e||s.buttonsMessage?{tag:"biz",attrs:{},content:[{tag:"interactive",attrs:{type:"native_flow",v:"1"},content:[{tag:"native_flow",attrs:{v:"9",name:"mixed"}}]}]}:s.listMessage?{tag:"biz",attrs:{},content:[{tag:"list",attrs:{v:"2",type:"product_list"}}]}:{tag:"biz",attrs:{}}}function $(s){if(s.interactiveButtons&&s.interactiveButtons.length>0){const e={nativeFlowMessage:{buttons:s.interactiveButtons.map(i=>({name:i.name||"quick_reply",buttonParamsJson:i.buttonParamsJson}))}};(s.title||s.subtitle)&&(e.header={title:s.title||s.subtitle||""}),s.text&&(e.body={text:s.text}),s.footer&&(e.footer={text:s.footer});const t={...s};return delete t.interactiveButtons,delete t.title,delete t.subtitle,delete t.text,delete t.footer,{...t,interactiveMessage:e}}return s}async function y(s,e,t,i={}){var c,l,o,g;if(!s)throw new Error("Socket is required for sendInteractiveMessage");const a=$(t),m=((o=(l=(c=s.authState)==null?void 0:c.creds)==null?void 0:l.me)==null?void 0:o.id)||((g=s.user)==null?void 0:g.id),r=_(e,a,{logger:s.logger,userJid:m,messageId:f?f():void 0,timestamp:new Date,...i}),n=p(r.message),u=C(n);let d=[...i.additionalNodes||[]];if(u){const v=I(n),M=!N(e);d.push(v),M&&d.push({tag:"bot",attrs:{biz_bot:"1"}})}return await s.relayMessage(e,r.message,{messageId:r.key.id,useCachedGroupMetadata:i.useCachedGroupMetadata,additionalAttributes:i.additionalAttributes||{},statusJidList:i.statusJidList,additionalNodes:d}),r}async function B(s,e,t={},i={}){const{text:a="",footer:m="",title:r,subtitle:n,buttons:u=[]}=t,d=k(u),c={text:a,footer:m,interactiveButtons:d};return r&&(c.title=r),n&&(c.subtitle=n),y(s,e,c,i)}class J{constructor(e){this.sock=e}decodeJid(e){return/:\d+@/gi.test(e)?w(e):e}async sendText(e,t,i={}){return await this.sock.sendMessage(e,{text:t},i)}async react(e,t,i){return await this.sock.sendMessage(e,{react:{text:i,key:t}})}async sendContact(e,t,i={}){const a=Array.isArray(t)?t:[t],m=a.map(r=>{const{name:n,number:u,about:d}=r;return`BEGIN:VCARD
VERSION:3.0
FN:${n}
TEL;type=CELL;type=VOICE;waid=${u}:${u}
${d?`NOTE:${d}
`:""}END:VCARD`}).join(`
`);return await this.sock.sendMessage(e,{contacts:{displayName:a.length===1?a[0].name:`${a.length} contacts`,contacts:a.map((r,n)=>({displayName:r.name,vcard:`BEGIN:VCARD
VERSION:3.0
FN:${r.name}
TEL;type=CELL;type=VOICE;waid=${r.number}:${r.number}
${r.about?`NOTE:${r.about}
`:""}END:VCARD`}))}},i)}async sendButtons(e,t,i={}){return await B(this.sock,e,t,i)}async sendInteractiveMessage(e,t,i={}){return await y(this.sock,e,t,i)}async getName(e){try{const t=await this.sock.onWhatsApp(e);if(t&&t[0]&&t[0].exists)return t[0].name||t[0].verifiedName||e.split("@")[0];const i=await this.sock.groupMetadata(e).catch(()=>null);return i?i.subject:e.split("@")[0]}catch{return e.split("@")[0]}}async downloadMediaMessage(e,t){let i={imageMessage:"image",videoMessage:"video",stickerMessage:"sticker",documentMessage:"document",audioMessage:"audio",ptvMessage:"video"}[e.type];return"thumbnailDirectPath"in e.msg&&!("url"in e.msg)?(e={directPath:e.msg.thumbnailDirectPath,mediaKey:e.msg.mediaKey},i="thumbnail-link"):e=e.msg,await h(await b(e,i))}parseMention(e){return[...e.matchAll(/@([0-9]{5,16}|0)/g)].map(t=>t[1]+"@s.whatsapp.net")||[]}async sendMedia(e,t,i="",a={}){var m,r;try{let{mime:n,data:u,ext:d,size:c}=await x.getFile(t);n=a!=null&&a.mimetype?a.mimetype:n;let l={text:""},o=/audio/i.test(n)?"audio/mp4":n;return c>45e6?l={document:u,mimetype:n,fileName:a!=null&&a.fileName?a.fileName:`${(m=this.sock.user)==null?void 0:m.name} (${new Date}).${d}`,...a}:a.asDocument?l={document:u,mimetype:n,fileName:a!=null&&a.fileName?a.fileName:`${(r=this.sock.user)==null?void 0:r.name} (${new Date}).${d}`,...a}:/image/.test(n)?l={image:u,mimetype:a!=null&&a.mimetype?a.mimetype:"image/png",...a}:/video/.test(n)?l={video:u,mimetype:a!=null&&a.mimetype?a.mimetype:"video/mp4",...a}:/audio/.test(n)?l={audio:u,mimetype:a!=null&&a.mimetype?a.mimetype:"audio/mp4",...a}:l={document:u,mimetype:n,...a},await this.sock.sendMessage(e,l,{quoted:i,...a})}catch(n){return n}}}export{J as Action};
